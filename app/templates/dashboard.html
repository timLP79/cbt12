{% extends "base.html" %}

{% block title %}Dashboard - CBT 12-Step Assessment{% endblock %}

{% block content %}
<h2>Welcome, {{ current_user.first_name }} {{ current_user.last_name }}</h2>

{# Unviewed Approval Banner #}
{% if unviewed_approval %}
<div class="alert alert-success">
    <button onclick="this.parentElement.style.display='none'"
            style="position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">
        &times;
    </button>
    <h3>Step
        {% if unviewed_approval.step %}
        {{ unviewed_approval.step.step_number }} Approved!
        {% else %}
        System
        {% endif %}
    </h3>
    <p><strong>Great work!</strong> Your Step {{ unviewed_approval.step.step_number }} assessment was reviewed and
        approved by
        {% if unviewed_approval.attempt.reviewer %}
        {{ unviewed_approval.attempt.reviewer.first_name }} {{ unviewed_approval.attempt.reviewer.last_name }}.
        {% else %}
        Clinician
        {% endif %}
    </p>
    {% if unviewed_approval.attempt.clinician_notes %}
    <p><strong>Clinician Notes:</strong></p>
    <blockquote>{{
        unviewed_approval.attempt.clinician_notes }}
    </blockquote>
    {% endif %}
    <p>You can now proceed to Step {{ current_step.step_number }}.</p>
    <form action="{{ url_for('main.dismiss_approval', attempt_id=unviewed_approval.attempt.attempt_id) }}" method="POST"
          style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <button type="submit" style="background: #28a745; color: white; padding: 0.5rem 1rem; margin-top: 0.5rem;">Got
            it, thanks!
        </button>
    </form>
</div>
{% endif %}

<div class="step-info">
    <h3>Current Step: {{ current_step.step_number }}</h3>
    <h4>{{ current_step.step_title }}</h4>
    <p>{{ current_step.step_description }}</p>
</div>

{# Assessment Status Section #}
{% if current_attempt %}
{% if current_attempt.status == 'submitted' %}
<div class="alert alert-warning">
    <h3>üìã Status: Pending Clinician Review</h3>
    <p>Your assessment was submitted on
        {% if current_attempt.submitted_at %}
        {{ current_attempt.submitted_at.strftime('%B %d, %Y at %I:%M %p') }}.
        {% else %}
        ---
        {% endif %}
    </p>
    <p><strong>You cannot proceed to the next step until a clinician reviews and approves your work.</strong></p>
    <p>Please check back later or contact your counselor for updates.</p>
</div>

{% elif current_attempt.status == 'in_progress' %}
<div class="alert alert-info">
    <h3>‚è∏ Assessment In Progress</h3>
    <p>You started this assessment but haven't finished yet.</p>
    <form action="{{ url_for('main.start_assessment', step_number=current_step.step_number) }}" method="GET">
        <button type="submit">Resume Assessment</button>
    </form>
</div>

{% elif current_attempt.status == 'approved' %}
<div class="alert alert-success">
    <h3>Assessment Approved!</h3>
    <p>Your work has been reviewed and approved by
        {% if current_attempt.reviewer %}
        {{ current_attempt.reviewer.first_name }} {{ current_attempt.reviewer.last_name }}.
        {% else %}
        Clinician
        {% endif %}
    </p>
    <p>You may now proceed to Step {{ current_step.step_number + 1 }}.</p>
    <form action="{{ url_for('main.start_assessment', step_number=current_step.step_number + 1) }}" method="GET">
        <button type="submit">Start Step {{ current_step.step_number + 1 }}</button>
    </form>
</div>

{% elif current_attempt.status == 'needs_revision' %}
<div class="alert alert-danger">
    <h3>Revision Requested</h3>
    <p><strong>Feedback  from
        {% if current_attempt.reviewer %}
        {{ current_attempt.reviewer.first_name }} {{ current_attempt.reviewer.last_name }}:
        {% else %}
        Clinician
        {% endif %}
    </strong></p>
    <blockquote>{{ current_attempt.clinician_notes }}</blockquote>
    <p>Please revise your work based on the feedback above.</p>
    <form action="{{ url_for('main.start_assessment', step_number=current_step.step_number) }}" method="GET">
        <button type="submit">Revise Your Work</button>
    </form>
</div>
{% endif %}

{% else %}
{# No attempt yet - show start button #}
<div class="alert alert-primary">
    <h3>Ready to Begin</h3>
    <p>You haven't started this assessment yet. Click below to begin.</p>
    <form action="{{ url_for('main.start_assessment', step_number=current_step.step_number) }}" method="GET">
        <button type="submit">Start Assessment</button>
    </form>
</div>
{% endif %}

<hr style="margin: 2rem 0;">

<h3>Your Progress</h3>
<p>Steps completed: {{ current_user.current_step - 1 }} of 12</p>

{# Assessment History Section #}
{% if previous_attempts %}
<hr style="margin: 2rem 0;">
<h3>Assessment History</h3>
<div style="margin-top: 1rem;">
    {% for prev in previous_attempts %}
    <div class="history-item {% if prev.attempt.status == 'approved' %}approved{% else %}pending{% endif %}">
        <h4 style="margin: 0 0 0.5rem 0;">Step {{ prev.step.step_number }}: {{ prev.step.step_title }}</h4>
        <p style="margin: 0.25rem 0;"><strong>Status:</strong>
            {% if prev.attempt.status == 'approved' %}
            <span>‚úì Approved</span>
            {% elif prev.attempt.status == 'needs_revision' %}
            <span>‚ö† Needs Revision</span>
            {% endif %}
        </p>
        <p style="margin: 0.25rem 0;"><strong>Reviewed by:</strong>
            {% if prev.attempt.reviewer %}
            {{ prev.attempt.reviewer.first_name }} {{ prev.attempt.reviewer.last_name }}
            {% else %}
            System
            {% endif %}
        </p>
        <p style="margin: 0.25rem 0;"><strong>Reviewed on:</strong>
            {% if prev.attempt.reviewed_at %}
            {{ prev.attempt.reviewed_at.strftime('%B %d, %Y') }}
            {% else %}
            ---
            {% endif %}
        </p>
        {% if prev.attempt.clinician_notes %}
        <p style="margin: 0.5rem 0 0 0;"><strong>Notes:</strong></p>
        <blockquote>{{
            prev.attempt.clinician_notes }}
        </blockquote>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}