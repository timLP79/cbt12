{% extends "base.html" %}

{% block title %}{{ action }} User - CBT 12-Step Assessment{% endblock %}

{% block content %}
<h2>{{ action }} User</h2>

<form method="POST" style="max-width: 600px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <label for="state_id">State ID: <span style="color: red;">*</span></label>
    <input type="text"
           id="state_id"
           name="state_id"
           value="{{ user.state_id if user else '' }}"
           {% if user %}readonly{% else %}required{% endif %}>
    {% if user %}
    <p class="text-muted" style="font-size: 0.9em; margin-top: 0.25rem;">
        State ID cannot be changed
    </p>
    {% endif %}

    <label for="first_name">First Name: <span style="color: red;">*</span></label>
    <input type="text"
           id="first_name"
           name="first_name"
           value="{{ user.first_name if user else '' }}"
           required>

    <label for="last_name">Last Name: <span style="color: red;">*</span></label>
    <input type="text"
           id="last_name"
           name="last_name"
           value="{{ user.last_name if user else '' }}"
           required>

    <label for="password">
        Password:
        {% if not user %}<span style="color: red;">*</span>{% endif %}
    </label>
    <input type="password"
           id="password"
           name="password"
           placeholder="{% if user %}Leave blank to keep current password{% else %}Min 4 chars, uppercase + special char{% endif %}"
           {% if not user %}required{% endif %}>
    {% if user %}
    <p class="text-muted" style="font-size: 0.9em; margin-top: 0.25rem;">
        Only fill in if you want to change the password
    </p>
    {% endif %}

    <label for="current_step">Current Step: <span style="color: red;">*</span></label>
    <select id="current_step" name="current_step" required>
        {% for step in range(1, 13) %}
        <option value="{{ step }}"
                {% if user and user.current_step== step %}selected
                {% elif not user and step== 1 %}selected{% endif %}>
            Step {{ step }}
        </option>
        {% endfor %}
    </select>

    <label for="assigned_admin_id">Assigned Admin:</label>
    <select id="assigned_admin_id" name="assigned_admin_id">
        <option value="">Unassigned</option>
        {% for admin in admins %}
        <option value="{{ admin.admin_id }}"
                {% if user and user.assigned_admin_id== admin.admin_id %}selected{% endif %}>
            {{ admin.first_name }} {{ admin.last_name }} ({{ admin.admin_id }})
        </option>
        {% endfor %}
    </select>
    <p class="text-muted" style="font-size: 0.9em; margin-top: 0.25rem;">
        Optional - assign a clinician to this participant
    </p>

    <div class="mt-1">
        <button type="submit" style="background: #28a745;">
            {{ action }} User
        </button>
        <a href="{{ url_for('manage.list_users') }}" class="text-muted" style="margin-left: 1rem;">
            Cancel
        </a>
    </div>
</form>

<div class="mt-1">
    <a href="{{ url_for('manage.list_users') }}">‚Üê Back to User List</a>
</div>

{% endblock %}