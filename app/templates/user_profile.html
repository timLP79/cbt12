{% extends "base.html" %}

{% block title %}User Profile - {{ user.state_id }}{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <a href="{{ url_for('manage.list_users') }}">‚Üê Back to User List</a>
</div>

<div style="display: flex; gap: 2rem; align-items: flex-start; margin-bottom: 2rem;">
    <div style="flex: 1; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #dee2e6;">
        <h2 style="margin-top: 0;">{{ user.first_name }} {{ user.last_name }}</h2>
        <p><strong>State ID:</strong> {{ user.state_id }}</p>
        <p><strong>Current Step:</strong> {{ user.current_step }}</p>
        <p><strong>Enrolled:</strong>
            {% if user.date_enrolled %}
            {{ user.date_enrolled.strftime('%B %d, %Y') }}
            {% else %}
            ---
            {% endif %}
        </p>
        <p>
            <strong>Assigned Admin:</strong>
            {% if user.assigned_admin %}
            {{ user.assigned_admin.first_name }} {{ user.assigned_admin.last_name }}
            {% else %}
            <em style="color: #6c757d;">Unassigned</em>
            {% endif %}
        </p>

        <div style="margin-top: 1rem;">
            <a href="{{ url_for('manage.edit_user', state_id=user.state_id) }}"
               style="display: inline-block; padding: 0.5rem 1rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
                Edit Details
            </a>
        </div>
    </div>

    <div style="width: 200px; background: #e7f3ff; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <h4 style="margin: 0; color: #0056b3;">Progress</h4>
        <div style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ ((user.current_step / 12) *
            100)|round|int }}%
        </div>
        <div style="color: #666; font-size: 0.9rem;">Step {{ user.current_step }} of 12</div>
    </div>
</div>

<h3>Assessment History</h3>
{% if attempts %}
<table style="width: 100%; border-collapse: collapse; margin-top: 1rem; background: white;">
    <thead>
    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
        <th style="padding: 0.75rem; text-align: left;">Step</th>
        <th style="padding: 0.75rem; text-align: left;">Status</th>
        <th style="padding: 0.75rem; text-align: left;">Started</th>
        <th style="padding: 0.75rem; text-align: left;">Submitted</th>
        <th style="padding: 0.75rem; text-align: left;">Reviewer</th>
        <th style="padding: 0.75rem; text-align: left;">Action</th>
    </tr>
    </thead>
    <tbody>
    {% for attempt in attempts %}
    <tr style="border-bottom: 1px solid #eee;">
        <td style="padding: 0.75rem;">
            {% if attempt.assessment %}
            Step {{ attempt.assessment.step.step_number }}
            {% else %}
            Unknown step
            {% endif %}
        </td>
        <td style="padding: 0.75rem;">
            {% if attempt.status == 'approved' %}
            <span style="background: #d4edda; color: #155724; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Approved</span>
            {% elif attempt.status == 'submitted' %}
            <span style="background: #fff3cd; color: #856404; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Pending</span>
            {% elif attempt.status == 'needs_revision' %}
            <span style="background: #f8d7da; color: #721c24; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Revision Needed</span>
            {% else %}
            <span style="background: #e2e3e5; color: #383d41; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">In Progress</span>
            {% endif %}
        </td>
        <td style="padding: 0.75rem; color: #666;">{{ attempt.started_at.strftime('%m/%d/%Y') if attempt.started_at else
            '---' }}
        </td>
        <td style="padding: 0.75rem; color: #666;">{{ attempt.submitted_at.strftime('%m/%d/%Y') if attempt.submitted_at
            else '---' }}
        </td>
        <td style="padding: 0.75rem;">
            {% if attempt.reviewer %}
            {{ attempt.reviewer.first_name[0] }}. {{ attempt.reviewer.last_name }}
            {% else %}
            <span style="color: #ccc;">---</span>
            {% endif %}
        </td>
        <td style="padding: 0.75rem;">
            {% if attempt.status == 'submitted' %}
            <a href="{{ url_for('admin.review_attempt', attempt_id=attempt.attempt_id) }}" style="color: #007bff;">Review</a>
            {% elif attempt.status != 'in_progress' %}
            <span style="color: #666; font-size: 0.9rem;">View</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p style="padding: 2rem; background: #f8f9fa; text-align: center; color: #6c757d; border-radius: 8px;">
    No assessment history found for this participant.
</p>
{% endif %}
{% endblock %}