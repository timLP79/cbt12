{% extends "base.html" %}

{% block title %}User Profile - {{ user.state_id }}{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <a href="{{ url_for('manage.list_users') }}">‚Üê Back to User List</a>
</div>

<div class="profile-grid">
    <div style="flex: 1; padding: 1.5rem; border-radius: 8px;">
        <h2 style="margin-top: 0;">{{ user.first_name }} {{ user.last_name }}</h2>
        <p><strong>State ID:</strong> {{ user.state_id }}</p>
        <p><strong>Current Step:</strong> {{ user.current_step }}</p>
        <p><strong>Enrolled:</strong>
            {% if user.date_enrolled %}
            {{ user.date_enrolled.strftime('%B %d, %Y') }}
            {% else %}
            ---
            {% endif %}
        </p>
        <p>
            <strong>Assigned Admin:</strong>
            {% if user.assigned_admin %}
            {{ user.assigned_admin.first_name }} {{ user.assigned_admin.last_name }}
            {% else %}
            <em class="text-muted">Unassigned</em>
            {% endif %}
        </p>

        <div class="mt-1">
            <a href="{{ url_for('manage.edit_user', state_id=user.state_id) }}" class="btn" style="background: #007bff;">
                Edit Details
            </a>
        </div>
    </div>

    <div style="width: 200px; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <h4 style="margin: 0;">Progress</h4>
        <div style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ ((user.current_step / 12) *
            100)|round|int }}%
        </div>
        <div class="text-muted" style="font-size: 0.9rem;">Step {{ user.current_step }} of 12</div>
    </div>
</div>

<h3>Assessment History</h3>
{% if attempts %}
<table>
    <thead>
    <tr>
        <th>Step</th>
        <th>Status</th>
        <th>Started</th>
        <th>Submitted</th>
        <th>Reviewer</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    {% for attempt in attempts %}
    <tr>
        <td>
            {% if attempt.assessment %}
            Step {{ attempt.assessment.step.step_number }}
            {% else %}
            Unknown step
            {% endif %}
        </td>
        <td>
            {% if attempt.status == 'approved' %}
            <span style="padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Approved</span>
            {% elif attempt.status == 'submitted' %}
            <span style="padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Pending</span>
            {% elif attempt.status == 'needs_revision' %}
            <span style="padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">Revision Needed</span>
            {% else %}
            <span style="padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem;">In Progress</span>
            {% endif %}
        </td>
        <td class="text-muted">{{ attempt.started_at.strftime('%m/%d/%Y') if attempt.started_at else
            '---' }}
        </td>
        <td class="text-muted">{{ attempt.submitted_at.strftime('%m/%d/%Y') if attempt.submitted_at
            else '---' }}
        </td>
        <td>
            {% if attempt.reviewer %}
            {{ attempt.reviewer.first_name[0] }}. {{ attempt.reviewer.last_name }}
            {% else %}
            <span class="text-muted">---</span>
            {% endif %}
        </td>
        <td>
            {% if attempt.status == 'submitted' %}
            <a href="{{ url_for('admin.review_attempt', attempt_id=attempt.attempt_id) }}">Review</a>
            {% elif attempt.status != 'in_progress' %}
            <span class="text-muted" style="font-size: 0.9rem;">View</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted" style="padding: 2rem; text-align: center; border-radius: 8px;">
    No assessment history found for this participant.
</p>
{% endif %}
{% endblock %}