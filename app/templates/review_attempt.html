{% extends "base.html" %}

{% block title %}Review Assessment - CBT 12-Step{% endblock %}

{% block content %}
<h2>Review Assessment</h2>

<!-- Participant Info -->
<div class="history-item mt-1">
    <h3>Participant Information</h3>
    <p><strong>Name:</strong> {{ attempt.user.first_name }} {{ attempt.user.last_name }}</p>
    <p><strong>State ID:</strong> {{ attempt.state_id }}</p>
    <p><strong>Step:</strong> {{ attempt.assessment.step.step_number }} - {{ attempt.assessment.step.step_title }}</p>
    <p><strong>Submitted:</strong> {{ attempt.submitted_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
    <p><strong>Attempt Number:</strong> {{ attempt.attempt_number }}</p>
</div>

<hr>

<!-- Questions and Responses -->
<h3 class="mt-1">Assessment Responses</h3>

{% for question in questions %}
<div style="background: #fff; border: 1px solid #ddd; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 5px;">
    <!-- Question -->
    <h4 style="color: #333; margin-bottom: 1rem;">
        Question {{ loop.index }}: {{ question.question_text }}
    </h4>

    <!-- Participant's Response -->
    {% set response = responses_by_question.get(question.question_id) %}

    {% if response %}
    <div class="step-info">
        <strong>Participant's Answer:</strong><br>

        {% if question.question_type == 'multiple_choice' %}
        <!-- Show selected option -->
        <p style="margin-top: 0.5rem;">{{ response.selected_option.option_text }}</p>
        {% else %}
        <!-- Show text response -->
        <p style="margin-top: 0.5rem; white-space: pre-wrap;">{{ response.response_text }}</p>
        {% endif %}
    </div>

    <!-- Clinician feedback for this response (if exists) -->
    {% if response.clinician_comment %}
    <div class="alert alert-warning">
        <strong>Previous Feedback:</strong><br>
        <p style="margin-top: 0.5rem;">{{ response.clinician_comment }}</p>
    </div>
    {% endif %}
    {% else %}
    <p class="text-muted" style="font-style: italic;">No response provided</p>
    {% endif %}
</div>
{% endfor %}

<hr style="margin: 2rem 0;">

<!-- Review Action Form -->
<h3>Review Decision</h3>

<form method="POST" action="{{ url_for('admin.submit_review', attempt_id=attempt.attempt_id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

    <div class="mb-1">
        <label for="clinician_notes"><strong>Clinician Notes:</strong></label>
        <textarea id="clinician_notes" name="clinician_notes" rows="5"
                  placeholder="Add any notes or feedback for the participant..."></textarea>
    </div>

    <div class="mb-1">
        <label><strong>Review Decision:</strong></label>
        <div style="margin-top: 0.5rem; display: flex; align-items: center;">
            <input type="radio" id="approve" name="decision" value="approve" required style="margin-right: 0.5rem; width: auto; margin-bottom: 0;">
            <label for="approve" style="margin: 0; margin-right: 2rem; cursor: pointer; font-weight: normal;">Approve (Advance to next step)</label>
        </div>
        <div style="margin-top: 0.5rem; display: flex; align-items: center;">
            <input type="radio" id="needs_revision" name="decision" value="needs_revision" required
                   style="margin-right: 0.5rem; width: auto; margin-bottom: 0;">
            <label for="needs_revision" style="margin: 0; cursor: pointer; font-weight: normal;">Needs Revision (Request changes)</label>
        </div>
    </div>

    <div class="mt-1">
        <button type="submit" style="background: #28a745;">
            Submit Review
        </button>

        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn" style="background: #6c757d; margin-left: 1rem;">
            Cancel
        </a>
    </div>
</form>

{% endblock %}