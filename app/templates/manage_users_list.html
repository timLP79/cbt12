{% extends "base.html" %}

{% block title %}Manage Users - CBT 12-Step Assessment{% endblock %}

{% block content %}
<h2>Manage Users</h2>

<!-- Search and Filter Form -->
<div class="alert alert-primary">
    <form method="GET" action="{{ url_for('manage.list_users') }}">
        <div class="filter-form">
            <div style="flex: 1; min-width: 200px;">
                <label for="search">Search:</label>
                <input type="text" id="search" name="search"
                       placeholder="State ID, name..."
                       value="{{ search }}">
            </div>

            <div style="min-width: 120px;">
                <label for="step">Step:</label>
                <select id="step" name="step">
                    <option value="">All Steps</option>
                    {% for step in range(1, 13) %}
                    <option value="{{ step }}" {% if step_filter== step|string %}selected{% endif %}>
                        Step {{ step }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="min-width: 150px;">
                <label for="admin">Assigned Admin:</label>
                <select id="admin" name="admin">
                    <option value="">All Admins</option>
                    {% for admin in all_admins %}
                    <option value="{{ admin.admin_id }}"
                            {% if admin_filter== admin.admin_id %}selected{% endif %}>
                        {{ admin.first_name }} {{ admin.last_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="display: flex; flex-direction: column;">
                <label style="visibility: hidden;">Filter:</label>
                <button type="submit" style="background: #28a745; line-height: 1;">
                    Filter
                </button>
            </div>

            {% if search or step_filter or admin_filter %}
            <div style="display: flex; flex-direction: column;">
                <label style="visibility: hidden;">Clear:</label>
                <a href="{{ url_for('manage.list_users') }}" class="btn" style="background: #6c757d; line-height: 1;">
                    Clear
                </a>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Create User Button -->
<div class="mb-1">
    <a href="{{ url_for('manage.create_user') }}" class="btn" style="background: #007bff;">
        + Create User
    </a>
</div>

<!-- Users Table -->
{% if users %}
<table>
    <thead>
    <tr>
        <th>State ID</th>
        <th>Name</th>
        <th>Current Step</th>
        <th>Assigned Admin</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for user in users %}
    <tr>
        <td>{{ user.state_id }}</td>
        <td>
            <a href="{{ url_for('manage.user_profile', state_id=user.state_id) }}"
               style="color: #007bff; text-decoration: none; font-weight: bold;">
                {{ user.first_name }} {{ user.last_name }}
            </a>
        </td>
        <td>{{ user.current_step }}</td>
        <td>
            {% if user.assigned_admin %}
            {{ user.assigned_admin.first_name }} {{ user.assigned_admin.last_name }}
            {% else %}
            <em class="text-muted">Unassigned</em>
            {% endif %}
        </td>
        <td>
            {% if user.is_active %}
            <span style="color: #28a745; white-space: nowrap;">● Active</span>
            {% else %}
            <span style="color: #dc3545; white-space: nowrap;">● Inactive</span>
            {% endif %}
        </td>
        <td style="white-space: nowrap;">
            <a href="{{ url_for('manage.edit_user', state_id=user.state_id) }}"
               style="color: #007bff; text-decoration: none; margin-right: 1rem;">Edit</a>

            {% if user.is_active %}
            <form method="POST"
                  action="{{ url_for('manage.deactivate_user', state_id=user.state_id) }}"
                  style="display: inline; margin: 0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        onclick="return confirm('Deactivate user {{ user.state_id }}?')"
                        style="background: none; border: none; color: #dc3545; cursor: pointer; text-decoration: underline; padding: 0; font: inherit;">
                    Deactivate
                </button>
            </form>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<p class="mt-1 text-muted">
    Showing {{ users|length }} user(s)
</p>

{% else %}
<div class="history-item mt-1" style="text-align: center;">
    <p class="text-muted">No users found.</p>
    {% if search or step_filter or admin_filter %}
    <p class="mt-1">
        <a href="{{ url_for('manage.list_users') }}">Clear filters</a>
    </p>
    {% endif %}
</div>
{% endif %}

<div class="mt-1">
    <a href="{{ url_for('admin.admin_dashboard') }}">← Back to Admin Dashboard</a>
</div>

{% endblock %}
